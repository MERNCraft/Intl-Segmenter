<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Word Boundaries</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        margin: 0;
        height: 100vh;
        color: #ddd;
        background-color: #111;

        & div#settings {
          background-color: #060;
          padding: 0 1em 1em;

          #use-css {
            opacity: 0.5;
            pointer-events: none;

            &.active {
              opacity: 1;
              pointer-events: all;
            }
          }

          & > label,
          & details > label {
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 1em;
          }

          & details {
            & div {
              text-align: center;
              margin-top: 1em;

              &.language {
                display: flex;
                justify-content: center;
                align-items: center;

                input[type=radio] {
                  position: absolute;
                  left: -999vw;

                  &:checked ~ img {
                    opacity: 1;
                    border-color: white;
                    box-shadow: 0 0 10px white;
                  }
                }
                & label img {
                  width: 1.5em;
                  margin-left: 0.5em;
                  opacity: 0.5;
                  border: 1px solid transparent;
                  border-radius: 1em;
                }
              }
            }
          }
        }


        & p[lang] {
          font-size: 1.2em;
          color: #0c0;
          text-align: center;
          display: none;
        }

        u {
          text-decoration: none;
        }

        &:has(#checkbox:checked) {
          & #source {
            color: #c00;

            /* use non-breaking spaces to force letters apart */
            i.after {
              &::after {
                content: "\00A0";
                display: inline-block;
              }
            }
            i.before::before {
              content: "\00A0";
              display: inline-block;
            }
            u {
              font-size: 0;
            }
          }
        }

        #segments {
          flex: 1;
          overflow-y: auto;
        }

        pre {
          white-space: pre-wrap;

          &::first-line {
            font-size: 1.5em;
          }
        }

        #identical {
          color: #0c0;
          text-align: center;

          &:empty {
            display: none;
          }
        }
      }

      .selected {
        display: block!important
      }
    </style>
  </head>

  <body>
    <div id="settings">
      <label id="use-css">
        <span>Use CSS to change the spacing:</span>
        <input type="checkbox" id="checkbox">
      </label>

      <details id="details">
        <summary>More</summary>

        <div class="language">
          <span>Text in:</span>
          <label>
            <input type="radio" name="language" id="ar" checked>
            <img src="images/ar.png" alt="عربي">
          </label>
          <label>
            <input type="radio" name="language" id="en" checked>
            <img src="images/en-GB.png" alt="English">
          </label>
          <label>
            <input type="radio" name="language" id="fr">
            <img src="images/fr-FR.png" alt="Français">
          </label>
          <label>
            <input type="radio" name="language" id="ja">
            <img src="images/ja.png" alt="日本語">
          </label>
          <label>
            <input type="radio" name="language" id="ru">
            <img src="images/ru.png" alt="Русский">
          </label>
          <label>
            <input type="radio" name="language" id="th">
            <img src="images/th.png" alt="ไทย">
          </label>
        </div>

        <div class="options">
          new Intl.Segmenter ({
          <label>
            <span>lang:</span>
            <select id="lang">
              <option value="ar">ar</option>
              <option value="en" selected>en</option>
              <option value="fr">fr</option>
              <option value="ja">ja</option>
              <option value="ru">ru</option>
              <option value="th">th</option>
            </select>
          </label>
          ,
          <label>
            <span>granularity:</span>
            <select id="granularity">
              <option value="grapheme">grapheme</option>
              <option value="word" selected>word</option>
              <option value="sentence">sentence</option>
            </select>
          </label>
          })
        </div>

        <label>
          <span>Compare segmentation across all languages</span>
          <input type="checkbox" id="check-all">
        </label>
      </details>
    </div>
    <p id="source" lang="en" class="selected"><i class="after">The<u> </u>ir</i><b>regular program<u> </u>mes</b><i class="before after">s<u class="space"> </u>end</i>s<u class="space"> </u>now.</p>
    <p lang="fr">Les premières occurrences du mot « France » en langue française se rencontrent au XIe siècle.</p>
    <p lang="ja">日本において、国号を直接かつ明確に規定した法令は存在しない。</p>
    <p lang="ru">Россия — многонациональное государство с широким этнокультурным многообразием.</p>
    <p lang="th">ประเทศไทยมีประชากรเกือบ 66 ล้านคน พื้นที่ประมาณ 513,115 ตารางกิโลเมตร</p>
    <p lang="ar">العربية لغةٌ رسمية في كل دول الوطن العربي</p>

    <pre id="words"></pre>
    <p id="identical"></p>
    <pre id="segments"></pre>


    <script>
      const useCSS = document.getElementById("use-css")
      const checkbox = document.getElementById("checkbox")
      const details = document.getElementById("details")
      const triggers = Array.from(
        document.querySelectorAll("[name=language]")
      )
      const checkAll = document.getElementById("check-all")
      const select = document.getElementById("lang")
      const granularity = document.getElementById("granularity")
      triggers.push(checkAll)
      triggers.push(select)
      triggers.push(granularity)

      const source = document.getElementById("source")
      const wordsPre = document.getElementById("words")
      const identical = document.getElementById("identical")
      const segmentsPre = document.getElementById("segments")
      const phrases = Array.from(
        document.querySelectorAll("p[lang]")
      )
      const langs = phrases.map(
        phrase => phrase.getAttribute("lang")
      )

      let languageId

      checkbox.addEventListener("change", segmentText)
      details.addEventListener("toggle", toggleDetails)
      triggers.forEach( trigger => {
        trigger.addEventListener("change", setLanguage)
      })


      function segmentText() {
        const selector = `p[lang=${languageId}]`
        const source = document.querySelector(selector)
        const text = source.textContent

        const lang = select.value
        const options = { granularity: granularity.value }
        const segmenter = new Intl.Segmenter(lang, options)
        const segments = Array.from(segmenter.segment(text))

        let items = segments
          .filter((item) => item.isWordLike)
          .map((item) => item.segment)

          if (items.length) {
          items = `words:
${JSON.stringify(items, null, "  ")}`
        } else {
          const count = segments.length
          const s = count === 1 ? "" : "s"
          items = `${segments.length} ${granularity.value}${s} found`
        }

        wordsPre.textContent = items
        segmentsPre.textContent = `segments:
${JSON.stringify(segments, null, "  ")}`

        if (checkAll.checked) {
          checkAllLanguageSettings(text)

        } else {
          identical.textContent = ""
        }
      }


      function checkAllLanguageSettings(text) {
        // Segment the current text using all values of lang
        const sets = langs.map( lang => {
          const options = { granularity: granularity.value }
          const segmenter = new Intl.Segmenter(lang, options)
          const segments = Array.from(segmenter.segment(text))
          segments.lang = lang

          return segments
        })

        // Pair each segmentation with one from a different lang
        const pairs = sets.reduce(( pairs, original, index) => {
          const compare =  (index)
            ? sets[index - 1]
            : sets[sets.length - 1]

            pairs.push([ original, compare ])
          return pairs
        }, [])

        const same = pairs.every(([ original, compare ]) => (
          JSON.stringify(original) === JSON.stringify(compare)
        ))

        identical.innerHTML = `Segmentation results with all language settings are: <b>${same ? "identical" : "different"}</b>`
      }


      function toggleDetails({ target }) {
        if (!target.open) {
          // Select English when details or closed
          checkAll.checked = false
          target = triggers[1]
          target.checked = true
          setLanguage({ target })
        }
      }


      function setLanguage({ target }) {
        const { id, tagName } = target
        if ( id !== "check-all"
          && id !== "lang"
          && id !== "granularity"
           ) {
          languageId = id
        }
        phrases.forEach( phrase => {
          const action = (phrase.getAttribute("lang") === languageId)
            ? "add"
            : "remove"
          phrase.classList[action]("selected")
        })

        const action = (id === "en")
          ? "add"
          : "remove"
          useCSS.classList[action]("active")

        segmentText()
      }


      const target = document.querySelector("[type=radio]:checked")
      setLanguage({ target })

    </script>
  </body>
</html>
